{% extends 'base.html' %}

{% block title %}edit project page{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Редактировать проект "{{ project.name }}"</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>
<div class="container my-5">
  <h1 class="mb-4">Редактировать проект: "{{ project.name }}"</h1>
  
  <form method="POST" action="{{ url_for('edit_project', project_id=project.id) }}">
    <fieldset class="mb-4">
      <legend>Информация о проекте</legend>
      <div class="mb-3">
        <label for="project_name" class="form-label">Название проекта:</label>
        <input type="text" class="form-control" id="project_name" name="project_name" value="{{ project.name }}" required>
      </div>
    </fieldset>
    
    <fieldset class="mb-4">
      <legend>Ресурсы</legend>
      <div class="table-responsive mb-3">
        <table class="table table-bordered align-middle" id="resources-table">
          <thead class="table-light">
            <tr>
              <th>№</th>
              <th>Название ресурса</th>
              <th>Вместимость</th>
              <th>Действие</th>
            </tr>
          </thead>
          <tbody>
            {% for r in resources %}
            <tr>
              <td>{{ loop.index }}</td>
              <input type="hidden" name="resource_id[]" value="{{ r.id }}">
              <td><input type="text" class="form-control"
                         name="resource_name[]"
                         value="{{ r.name }}" required></td>
              <td><input type="number" class="form-control"
                         name="resource_capacity[]"
                         value="{{ r.capacity }}" required></td>
              <td><button type="button" class="btn btn-danger"
                          onclick="deleteRow(this)">Удалить</button></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <button type="button" class="btn btn-secondary" onclick="addResourceRow()">Добавить ресурс</button>
    </fieldset>
    
    <fieldset class="mb-4">
      <legend>Задачи</legend>
      <div class="table-responsive mb-3">
        <table class="table table-bordered align-middle" id="tasks-table">
          <thead class="table-light">
            <tr>
              <th>№</th>
              <th>Название задачи</th>
              <th>Длительность (в днях)</th>
              <th>Действие</th>
            </tr>
          </thead>
          <tbody>
            {% for t in tasks %}
            <tr>
              <td>{{ loop.index }}</td>
              <input type="hidden" name="task_id[]" value="{{ t.id }}">
              <td><input type="text" class="form-control"
                         name="task_name[]"
                         value="{{ t.name }}" required></td>
              <td><input type="number" class="form-control"
                         name="task_duration[]"
                         value="{{ t.duration }}" required></td>
              <td><button type="button" class="btn btn-danger"
                          onclick="deleteRow(this)">Удалить</button></td>
            </tr>
            {% endfor %}
          </tbody>          
        </table>
      </div>
      <button type="button" class="btn btn-secondary" onclick="addTaskRow()">Добавить задачу</button>
    </fieldset>
    
    <fieldset class="mb-4">
      <legend>Ресурсное потребление для задач</legend>

      <div class="table-responsive mb-3">
        <table class="table table-bordered align-middle" id="usage-table">
          <thead class="table-light">
            <tr>
              <th>№ задачи</th>
              <th>Ресурс</th>
              <th>Вместимость</th>
              <th>Действие</th>
            </tr>
          </thead>

          <tbody>
            {#  ▸ для каждой задачи … #}
            {% for t in tasks %}
              {% set t_index = loop.index %}

              {#  ▸ … перебираем все ресурсы проекта #}
              {% for res in resources %}
                {% set amount = usage_data.get((t.id, res.id), 0) %}
                <tr>
                  <td>
                    <input type="number" class="form-control"
                          name="usage_task[]" value="{{ t_index }}" readonly>
                  </td>

                  <td>
                    <select name="usage_resource[]" class="form-select" required>
                      {% for r in resources %}
                        <option value="{{ r.id }}"
                                {% if r.id == res.id %}selected{% endif %}>
                          {{ r.name }}
                        </option>
                      {% endfor %}
                    </select>
                  </td>

                  <td>
                    <input type="number" class="form-control"
                          name="usage_amount[]" value="{{ amount }}" required>
                  </td>

                  <td>
                    <button type="button" class="btn btn-danger"
                            onclick="deleteRow(this)">Удалить</button>
                  </td>
                </tr>
              {% endfor %}
            {% endfor %}
          </tbody>
        </table>
      </div>

      <button type="button" class="btn btn-secondary"
              onclick="addUsageRow()">Добавить строку потребления</button>
    </fieldset>

    <fieldset class="mb-4">
      <legend>Зависимости</legend>
      <div class="table-responsive mb-3">
        <table class="table table-bordered align-middle" id="dep-table">
          <thead class="table-light">
            <tr>
              <th>Предшественник (№ задачи)</th>
              <th>Преемник (№ задачи)</th>
              <th>Действие</th>
            </tr>
          </thead>
          <tbody>
            {% for dep in precedences %}
            <tr>
              <td>
                <input  type="number" class="form-control"
                        name="predecessor_id[]"
                        value="{{ task_index_map[dep.predecessor_id] }}" required>
              </td>
              <td>
                <input  type="number" class="form-control"
                        name="successor_id[]"
                        value="{{ task_index_map[dep.successor_id] }}" required>
              </td>
              <td>
                <button type="button" class="btn btn-danger"
                        onclick="deleteRow(this)">Удалить</button>
              </td>
            </tr>
            {% endfor %}
          
            {# если зависимостей ещё нет — пустая строка #}
            {% if precedences|length == 0 %}
            <tr>
              <td><input type="number" class="form-control"
                         name="predecessor_id[]" placeholder="№ задачи" required></td>
              <td><input type="number" class="form-control"
                         name="successor_id[]" placeholder="№ задачи" required></td>
              <td><button type="button" class="btn btn-danger"
                          onclick="deleteRow(this)">Удалить</button></td>
            </tr>
            {% endif %}
          </tbody>          
        </table>
      </div>
      <button type="button" class="btn btn-secondary" onclick="addDepRow()">Добавить строку зависимости</button>
    </fieldset>

    <div class="mb-4">
      <input type="submit" class="btn btn-primary" value="Сохранить изменения">
    </div>
  </form>

  <a href="{{ url_for('projects') }}" class="btn btn-outline-primary">Вернуться к списку проектов</a>
</div>

<script>
var resList = [
{% for r in resources %}
  {"id": {{ r.id }}, "name": "{{ r.name | e }}"}{% if not loop.last %},{% endif %}
{% endfor %}
];
</script>
<script>
function deleteRow(button) {
  let row = button.parentNode.parentNode;
  row.parentNode.removeChild(row);
  updateRowNumbers();
}

function updateRowNumbers() {
  const tRows = document.querySelectorAll("#tasks-table tbody tr");
  tRows.forEach((tr, i) => {
    tr.cells[0].textContent = i + 1;
  });

  document.querySelectorAll('input[name="usage_task[]"]').forEach(inp => {
    const rowIdx = Array.from(tRows).indexOf(
      document.querySelector(`#tasks-table tbody tr:nth-child(${inp.value})`)
    );
    if (rowIdx > -1) inp.value = rowIdx + 1;
  });

  document.querySelectorAll('input[name="predecessor_id[]"], input[name="successor_id[]"]')
    .forEach(inp => {
      const rowIdx = Array.from(tRows).indexOf(
        document.querySelector(`#tasks-table tbody tr:nth-child(${inp.value})`)
      );
      if (rowIdx > -1) inp.value = rowIdx + 1;
    });
}

function addTaskRow() {
  let tbody = document.querySelector("#tasks-table tbody");
  let rowCount = tbody.rows.length;
  let row = tbody.insertRow(rowCount);

  let cell1 = row.insertCell(0);
  cell1.textContent = rowCount + 1;

  let cell2 = row.insertCell(1);
  cell2.innerHTML = '<input type="text" name="task_name[]" placeholder="Название задачи" required>';

  let cell3 = row.insertCell(2);
  cell3.innerHTML = '<input type="number" name="task_duration[]" value="1" required>';

  let cell4 = row.insertCell(3);
  cell4.innerHTML = '<button type="button" onclick="deleteRow(this)">Удалить</button>';
}

function addResourceRow() {
  const tbody = document.querySelector("#resources-table tbody");
  const rowCount = tbody.rows.length;
  const row = tbody.insertRow(rowCount);

  row.insertCell(0).textContent = rowCount + 1;
  row.insertCell(1).innerHTML = '<input type="hidden" name="resource_id[]" value="">' +
                                '<input type="text" name="resource_name[]" placeholder="Название ресурса" required>';
  row.insertCell(2).innerHTML = '<input type="number" name="resource_capacity[]" value="1" required>';
  row.insertCell(3).innerHTML = '<button type="button" onclick="deleteRow(this)" class="btn btn-danger">Удалить</button>';

  resList.push({ id: "", name: "" });
}

function addUsageRow() {
  let tbody = document.querySelector("#usage-table tbody");
  let row = tbody.insertRow(-1);

  let cell1 = row.insertCell(0);
  cell1.innerHTML = '<input type="number" name="usage_task[]" placeholder="Номер задачи" required>';

  let cell2 = row.insertCell(1);
  let selectHTML = '<select name="usage_resource[]" class="usage-resource" required>';
  for (let i = 0; i < resList.length; i++) {
    selectHTML += `<option value="${resList[i].id}">${resList[i].name}</option>`;
  }
  selectHTML += '</select>';
  cell2.innerHTML = selectHTML;

  let cell3 = row.insertCell(2);
  cell3.innerHTML = '<input type="number" name="usage_amount[]" value="0" required>';

  let cell4 = row.insertCell(3);
  cell4.innerHTML = '<button type="button" onclick="deleteRow(this)">Удалить</button>';
}

function addDepRow() {
  const tbody = document.querySelector("#dep-table tbody");
  const row   = tbody.insertRow(-1);

  row.insertCell(0).innerHTML =
      '<input type="number" class="form-control" ' +
      'name="predecessor_id[]" placeholder="№ задачи" required>';

  row.insertCell(1).innerHTML =
      '<input type="number" class="form-control" ' +
      'name="successor_id[]" placeholder="№ задачи" required>';

  row.insertCell(2).innerHTML =
      '<button type="button" class="btn btn-danger" ' +
      'onclick="deleteRow(this)">Удалить</button>';
}

</script>
</body>
</html>
{% endblock %}